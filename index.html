<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bespoke Shade Maker — Lampshade Pattern PWA</title>
  <meta name="theme-color" content="#2b6cb0">
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <style>
    :root{--bg:#f7fbff;--card:#fff;--accent:#2b6cb0;--muted:#637381}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans',sans-serif;background:var(--bg);color:#0b1220;font-size:20px;touch-action:manipulatio[...]
    .wrap{max-width:800px;margin:8px auto;padding:8px}
    header{display:flex;gap:12px;align-items:center}
    h1{margin:0;font-size:22px}
    .card{background:var(--card);border-radius:12px;padding:10px;box-shadow:0 3 10px rgba(11,18,32,.10);margin-bottom:10px}
    .grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    label{display:block;font-size:15px;color:var(--muted);margin-bottom:6px}
    input[type=number],select{width:100%;padding:14px 8px;border-radius:8px;border:1px solid #e6eef6;font-size:18px}
    .row{display:flex;gap:8px}
    .small{width:120px}
    .controls{display:flex;gap:8px;align-items:center;margin-top:14px;flex-wrap:wrap;}
    button{background:var(--accent);border:none;color:white;padding:18px 0;;border-radius:8px;font-weight:600;cursor:pointer;font-size:18px;width:100%;margin-top:8px}
    .footer,.info{font-size:15px;color:var(--muted);margin-top:12px}
    @media (max-width:700px){body{font-size:22px;}.wrap{max-width:none;margin:0;padding:0}.grid{grid-template-columns:1fr}.card{padding:8px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="card" style="display:inline-flex;padding:10px 14px;align-items:center;gap:12px">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" aria-hidden>
          <path d="M12 2l2.5 5 5.5 1-4 4 1 5.5L12 16l-5 3.5L8 12 4 8l5.5-1L12 2z" fill="#2b6cb0" />
        </svg>
        <div>
          <h1>Bespoke Shade Maker</h1>
          <div style="font-size:13px;color:var(--muted)">Create printable lampshade templates — PWA-ready</div>
        </div>
      </div>
      <div style="flex:1"></div>
    </header>
    <div class="grid">
      <div class="card">
        <h2 style="margin:0 0 8px 0">Inputs</h2>
        <div style="display:grid;gap:10px">
          <div>
            <label>Units</label>
            <div class="row">
              <select id="unit">
                <option value="mm">Millimetres (mm)</option>
                <option value="in">Inches (in)</option>
              </select>
              <div style="display:flex;align-items:center;margin-left:6px;color:var(--muted);font-size:15px">Toggle units — inputs update</div>
            </div>
          </div>
          <div class="row">
            <div style="flex:1">
              <label>Top diameter</label>
              <input id="topD" type="number" step="0.1" min="1" value="150" />
            </div>
            <div style="flex:1">
              <label>Bottom diameter</label>
              <input id="botD" type="number" step="0.1" min="1" value="300" />
            </div>
          </div>
          <div>
            <label>Height (vertical)</label>
            <input id="height" type="number" step="0.1" min="1" value="220" />
          </div>
          <div class="row">
            <div style="flex:1">
              <label>Seam allowance (along straight edge)</label>
              <input id="seam" type="number" step="0.1" min="0" value="10" />
            </div>
            <div style="flex:1">
              <label>Bend allowance (top/bottom fold)</label>
              <input id="fold" type="number" step="0.1" min="0" value="8" />
            </div>
          </div>
          <div>
            <label>Scale to fit page width when printing</label>
            <select id="paperScale">
              <option value="fit">Fit to page width (A4/Letter)</option>
              <option value="1">1:1 (actual size)</option>
              <option value="0.5">50%</option>
            </select>
          </div>
          <div class="controls">
            <!-- Will be replaced by script with Print/Open buttons -->
          </div>
          <div class="info">
            This generator calculates the unwrapped lateral surface of a lampshade (truncated cone). The template will be exported as a printable, multipage PDF, ready for assembly. Mathematical notes[...]
          </div>
        </div>
      </div>
    </div>
    <footer style="margin-top:14px;text-align:center;color:var(--muted);font-size:13px">Offline-capable PWA — add to home screen to install.</footer>
  </div>
  <script>
    // --- PDF + Geometry Utilities ---
    function toMM(value, unit){ return unit === 'mm' ? Number(value) : Number(value) * 25.4 }
    function fromMM(value, unit){ return unit === 'mm' ? value : value / 25.4 }
    function computeAnnularSector(r1, r2, h){
      if (r2 === r1) r2 = r1 + 0.00001;
      const s = Math.sqrt((r2 - r1) * (r2 - r1) + h * h);
      const L2 = s * r2 / (r2 - r1);
      const L1 = s * r1 / (r2 - r1);
      const theta = 2 * Math.PI * (r2 - r1) / s;
      return {s, L1, L2, theta};
    }
    function polarToCartesian(r, angle, cx, cy){
      return {x: cx + r * Math.cos(angle), y: cy + r * Math.sin(angle)};
    }

    // UI: replace single button with Open + Print (keeps the same id for backwards compatibility)
    const controls = document.querySelector('.controls');
    controls.innerHTML = `
      <button id="openPdfBtn" style="width:48%;">Open PDF</button>
      <button id="printPdfBtn" style="width:48%;">Print PDF</button>
    `;

    async function generatePdfBlob(options = {}) {
      const unit = document.getElementById('unit').value;
      const topD = Number(document.getElementById('topD').value);
      const botD = Number(document.getElementById('botD').value);
      const height = Number(document.getElementById('height').value);
      const seam = Number(document.getElementById('seam').value);
      const fold = Number(document.getElementById('fold').value);
      const paperScale = document.getElementById('paperScale').value;
      const PDFLib = window.PDFLib || window['PDFLib'] || window['pdf-lib'] || window.pdfLib;
      if (!PDFLib) throw new Error('pdf-lib is not loaded. Make sure the <script> for pdf-lib is present and loaded.');
      const { PDFDocument } = PDFLib;
      const pdfDoc = await PDFDocument.create();

      // PDF: A4 (595x842pt)
      const pageWidth = 595, pageHeight = 842, margin = 28;
      // Geometry calculations in mm
      const topR = toMM(topD/2, unit), botR = toMM(botD/2, unit), h = toMM(height, unit);
      const seamMM = toMM(seam, unit), foldMM = toMM(fold, unit);
      const geom = computeAnnularSector(topR, botR, h);
      // sector radii in mm
      const rInner = geom.L1 + foldMM;
      const rOuter = geom.L2 + foldMM + seamMM;
      const angleSpan = geom.theta; // radians

      // segment drawing parameters (radians per page)
      const maxSegment = Math.PI * 0.8;
      let currentAngle = -angleSpan/2;
      let pageNum = 1;

      // Offscreen canvas used to draw each page
      while (currentAngle < angleSpan/2) {
        const thisStart = currentAngle;
        const thisEnd = Math.min(currentAngle + maxSegment, angleSpan/2);

        // create canvas sized to PDF points
        const canvas = document.createElement('canvas');
        canvas.width = pageWidth;
        canvas.height = pageHeight;
        const ctx = canvas.getContext('2d');

        // white background
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // draw title
        ctx.fillStyle = '#1f2d55';
        ctx.font = '16px system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial';
        ctx.fillText(`Lampshade Template (Pg ${pageNum})`, margin, 40);

        // center and scale: convert mm radii into pixels for canvas sized to points
        // treat 1pt == 1 canvas pixel for simple mapping
        const cx = pageWidth / 2;
        const cy = pageHeight / 2 - 10;
        const drawMaxR = Math.min((pageWidth - 2 * margin), (pageHeight - 2 * margin) - 40) / 2;
        const scale = drawMaxR / rOuter;

        // build path for the annular sector on canvas
        const steps = 360; // resolution for arcs
        ctx.beginPath();
        // outer arc from start->end
        for (let i = 0; i <= steps; i++) {
          const t = thisStart + (thisEnd - thisStart) * (i / steps);
          const p = polarToCartesian(rOuter * scale, t, cx, cy);
          if (i === 0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y);
        }
        // inner arc from end->start (reverse)
        for (let i = steps; i >= 0; i--) {
          const t = thisStart + (thisEnd - thisStart) * (i / steps);
          const p = polarToCartesian(rInner * scale, t, cx, cy);
          ctx.lineTo(p.x, p.y);
        }
        ctx.closePath();

        // fill and stroke
        ctx.fillStyle = '#ffffff';
        ctx.fill();
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#2b6cb0';
        ctx.stroke();

        // dashed cut/align lines (straight edges)
        const startPtOut = polarToCartesian(rOuter * scale, thisStart, cx, cy);
        const startPtIn = polarToCartesian(rInner * scale, thisStart, cx, cy);
        const endPtOut = polarToCartesian(rOuter * scale, thisEnd, cx, cy);
        const endPtIn = polarToCartesian(rInner * scale, thisEnd, cx, cy);

        ctx.setLineDash([6, 4]);
        ctx.strokeStyle = 'rgba(200,40,40,0.95)';
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.moveTo(startPtOut.x, startPtOut.y);
        ctx.lineTo(startPtIn.x, startPtIn.y);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(endPtOut.x, endPtOut.y);
        ctx.lineTo(endPtIn.x, endPtIn.y);
        ctx.stroke();
        ctx.setLineDash([]);

        // page join labels
        ctx.fillStyle = 'rgba(60,10,40,0.8)';
        ctx.font = '10px system-ui, sans-serif';
        if (thisEnd < angleSpan / 2) ctx.fillText('Align with Pg ' + (pageNum + 1), endPtOut.x + 8, endPtOut.y + 4);
        if (pageNum > 1) ctx.fillText('Align with Pg ' + (pageNum - 1), startPtOut.x - 56, startPtOut.y + 4);

        // dimensions text
        ctx.fillStyle = '#222';
        ctx.font = '11px system-ui, sans-serif';
        ctx.fillText(`Outer radius: ${fromMM(rOuter, unit).toFixed(2)} ${unit}`, margin, pageHeight - margin - 8);
        ctx.fillText(`Inner radius: ${fromMM(rInner, unit).toFixed(2)} ${unit}`, margin, pageHeight - margin - 22);
        ctx.fillText(`Sector angle: ${(geom.theta * 180 / Math.PI).toFixed(2)}°`, margin, pageHeight - margin - 36);

        // embed the canvas as PNG image into pdf-lib
        const pngDataUrl = canvas.toDataURL('image/png');
        const pngBytes = await (await fetch(pngDataUrl)).arrayBuffer();
        const embeddedImage = await pdfDoc.embedPng(pngBytes);
        const page = pdfDoc.addPage([pageWidth, pageHeight]);
        page.drawImage(embeddedImage, {
          x: 0,
          y: 0,
          width: pageWidth,
          height: pageHeight
        });

        currentAngle = thisEnd;
        pageNum++;
      }

      const pdfBytes = await pdfDoc.save();
      return new Blob([pdfBytes], { type: 'application/pdf' });
    }

    async function openPdf() {
      try {
        const blob = await generatePdfBlob();
        const url = URL.createObjectURL(blob);
        const ok = window.open(url, '_blank');
        if (!ok) {
          // popup blocked
          alert('Popup blocked. Please allow popups to open the PDF or use the Print button.');
        }
        // cleanup after some time
        setTimeout(() => URL.revokeObjectURL(url), 60_000);
      } catch (err) {
        console.error(err);
        alert('Failed to generate PDF: ' + (err && err.message ? err.message : err));
      }
    }

    async function printPdf() {
      try {
        const blob = await generatePdfBlob();
        const url = URL.createObjectURL(blob);
        const w = window.open('about:blank');
        if (!w) {
          alert('Popup blocked. Please allow popups to use the print workflow.');
          URL.revokeObjectURL(url);
          return;
        }
        // write an iframe that will call print when loaded
        w.document.open();
        w.document.write(`<!doctype html><title>Print PDF</title>
          <style>html,body{height:100%;margin:0}</style>
          <iframe src="${url}" style="border:none;width:100%;height:100vh;" onload="this.contentWindow.focus();this.contentWindow.print();"></iframe>`);
        w.document.close();
        // revoke later
        setTimeout(() => URL.revokeObjectURL(url), 60_000);
      } catch (err) {
        console.error(err);
        alert('Failed to generate/print PDF: ' + (err && err.message ? err.message : err));
      }
    }

    document.getElementById('openPdfBtn').addEventListener('click', openPdf);
    document.getElementById('printPdfBtn').addEventListener('click', printPdf);

    // PWA service worker remains unchanged
    const swScript = `self.addEventListener('install', event => { self.skipWaiting(); });
      self.addEventListener('activate', event => { event.waitUntil(self.clients.claim()); });
      self.addEventListener('fetch', event => { event.respondWith(fetch(event.request).catch(()=>caches.match(event.request))); });`;
    if ('serviceWorker' in navigator){
      const blob = new Blob([swScript],{type:'application/javascript'});
      const swUrl = URL.createObjectURL(blob);
      navigator.serviceWorker.register(swUrl).then(()=>console.log('SW registered')).catch(()=>console.log('SW registration failed'));
    }
  </script>
</body>
</html>